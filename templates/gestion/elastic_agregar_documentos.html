<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Documentos - Elasticsearch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/temaindext.css') }}" rel="stylesheet">
</head>
<body>
<div class="landing-page">
    <header>
      <div class="container">
        <a href="#" class="logo">Big <b>Data</b></a>
        <ul class="links">
          <li class="nav-item"><a class="nav-link" href="/gestion_proyecto" active><b>Gestionar Mongo Db</b></a></li>
          <li class="nav-item"><a class="nav-link" href="/elasticAdmin">Gestionar Elastic</a></li>
          <li class="nav-item"><a class="nav-link" href="/">Salir</a></li>
        </ul>
      </div>
    </header>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="card-title mb-0">Agregar Documentos al Índice: {{ index_name }}</h3>
                            <a href="{{ url_for('elasticAdmin') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Volver
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Formulario ZIP a Elasticsearch -->
                        <form id="uploadForm" method="POST" action="{{ url_for('elastic_agregar_documentos') }}" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="zipFile" class="form-label">Archivo ZIP con documentos JSON</label>
                                <input type="file" class="form-control" id="zipFile" name="zipFile" accept=".zip" required>
                                <div class="form-text">Seleccione un archivo ZIP que contenga documentos JSON para indexar.</div>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    Indexar Documentos
                                </button>
                            </div>
                        </form>

                        <!-- SECCIÓN WEB SCRAPING -->
                        <hr class="my-4">

                        <h4 class="mb-3">Web Scraping y descarga de documentos</h4>

                        <form id="formWebScraping" onsubmit="enviarWebScraping(event)">
                          <div class="mb-3">
                            <label for="ws_url" class="form-label">URL inicial</label>
                            <input type="text" class="form-control" id="ws_url"
                                   placeholder="https://www.minjusticia.gov.co/normatividad-co/Paginas/default.aspx" required>
                          </div>

                          <div class="mb-3">
                            <label for="ws_ext_navegar" class="form-label">
                              Extensiones a navegar (páginas intermedias)
                            </label>
                            <input type="text" class="form-control" id="ws_ext_navegar" value="aspx">
                            <div class="form-text">Separadas por coma. Ejemplo: aspx,php</div>
                          </div>

                          <div class="mb-3">
                            <label for="ws_tipos_archivos" class="form-label">
                              Tipos de archivos a descargar
                            </label>
                            <input type="text" class="form-control" id="ws_tipos_archivos" value="pdf">
                            <div class="form-text">Separadas por coma. Ejemplo: pdf,docx,xlsx</div>
                          </div>

                          <button type="submit" class="btn btn-secondary" id="ws_btn">
                            Ejecutar Web Scraping
                          </button>
                        </form>

                        <div id="ws_resultado" class="mt-3"></div>
                        <!-- FIN SECCIÓN WEB SCRAPING -->

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de éxito -->
    {% if success_message %}
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="successModalLabel">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-check-circle me-2" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-4.146-2.354a.5.5 0 0 0-.708-.708L7.5 8.793 6.354 7.647a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0l3-3z"/>
                <path d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14z"/>
              </svg>
              Documentos indexados
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            {{ success_message }}
          </div>
        </div>
      </div>
    </div>
    <script>
      window.onload = function() {
        var modal = new bootstrap.Modal(document.getElementById('successModal'));
        modal.show();
        setTimeout(function(){ modal.hide(); }, 4000);
      }
    </script>
    {% endif %}

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Manejo del submit del ZIP
        $(document).ready(function() {
            $('#uploadForm').on('submit', function() {
                const submitBtn = $('#submitBtn');
                const spinner = submitBtn.find('.spinner-border');

                submitBtn.prop('disabled', true);
                spinner.removeClass('d-none');
            });
        });

        // Llamado al endpoint de WebScraping con logs de depuración
        async function enviarWebScraping(e) {
          e.preventDefault();

          const btn = document.getElementById('ws_btn');
          const div = document.getElementById('ws_resultado');

          btn.disabled = true;
          btn.textContent = 'Procesando...';
          div.innerHTML = '<div class="alert alert-info">Ejecutando web scraping, procesando e indexando documentos, por favor espere...</div>';

          try {
            const body = {
              url: document.getElementById('ws_url').value,
              extensiones_navegar: document.getElementById('ws_ext_navegar').value,
              tipos_archivos: document.getElementById('ws_tipos_archivos').value,
              index: '{{ index_name }}'
            };

            const res = await fetch('/procesar-webscraping-elastic', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(body)
            });

            console.log('STATUS', res.status);
            const rawText = await res.text();
            console.log('RAW RESPONSE', rawText);

            let data;
            try {
              data = JSON.parse(rawText);
            } catch (err) {
              console.error('JSON parse error', err);
              div.innerHTML = `<div class="alert alert-danger">La respuesta del servidor no es JSON válido.</div>`;
              return;
            }
            console.log('DATA', data);

            if (data.success) {
              const archivos = data.archivos || [];
              let lista = '';
              if (archivos.length > 0) {
                lista = '<ul class="mt-2">';
                archivos.forEach(a => {
                  const url = `/static/uploads/${a.nombre}`;
                  lista += `<li><a href="${url}" target="_blank">${a.nombre}</a> (${a.tamaño || a.tamano || 0} bytes)</li>`;
                });
                lista += '</ul>';
              }

              const stats = data.stats || {};

              div.innerHTML = `
                <div class="alert alert-success">
                  Proceso completado.<br>
                  Archivos descargados: ${archivos.length}<br>
                  Indexados en Elastic: ${data.indexados || 0}<br>
                  Errores de indexación: ${data.errores || 0}<br>
                  Total enlaces: ${stats.total_enlaces || 0}<br>
                  Descargados: ${stats.descargados || 0}<br>
                  Errores descarga: ${stats.errores_descarga || 0}
                  ${lista}
                </div>
              `;
            } else {
              div.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Error desconocido'}</div>`;
            }
          } catch (err) {
            console.error(err);
            div.innerHTML = `<div class="alert alert-danger">Error en la petición: ${err}</div>`;
          } finally {
            btn.disabled = false;
            btn.textContent = 'Ejecutar Web Scraping';
          }
        }
    </script>
</div>

<div class="main"></div>
<div class="footer">
  <div class="bubbles">
    <!-- ...tu código de las burbujas sigue igual... -->
  </div>
  <div class="content">
    <div>
      <div><b>Creado Por: </b><a href="#">David Mateo Morales Romero</a></br>
        <b>Maestria en Analitica de Datos </b><a href="mailto:dmoralesr1@ucentral.edu.co"></a></br>
        <b>Correo: dmoralesr1@ucentral.edu.co</b></br>
      </div>
    </div>
    <div>
      <a class="image" href="https://www.ucentral.edu.co/" target="_blank"
         style="background-image: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/199011/happy.svg')"></a>
      <p>Versión 2.0 del 1 de Diciembre de 2025 </p>
    </div>
  </div>
</div>

<svg style="position: fixed; top: 100vh; display: none;">
  <defs>
    <filter id="blob">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur"></feGaussianBlur>
      <feColorMatrix in="blur" mode="matrix"
                     values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 19 -9"
                     result="blob"></feColorMatrix>
    </filter>
  </defs>
</svg>
</body>
</html>
